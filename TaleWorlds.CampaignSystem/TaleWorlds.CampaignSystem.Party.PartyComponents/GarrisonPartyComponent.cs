using System.Collections.Generic;
using TaleWorlds.CampaignSystem.Settlements;
using TaleWorlds.Core;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.CampaignSystem.Party.PartyComponents;

public class GarrisonPartyComponent : PartyComponent
{
	[CachedData]
	private TextObject _cachedName;

	public override Hero PartyOwner => Settlement.OwnerClan.Leader;

	public override TextObject Name
	{
		get
		{
			if (_cachedName == null)
			{
				_cachedName = GameTexts.FindText("str_garrison_party_name");
				_cachedName.SetTextVariable("MAJOR_PARTY_LEADER", Settlement.Name);
			}
			return _cachedName;
		}
	}

	public override Settlement HomeSettlement => Settlement;

	public override int WagePaymentLimit => Settlement.GarrisonWagePaymentLimit;

	[SaveableProperty(1)]
	public Settlement Settlement { get; private set; }

	internal static void AutoGeneratedStaticCollectObjectsGarrisonPartyComponent(object o, List<object> collectedObjects)
	{
		((GarrisonPartyComponent)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected override void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
		base.AutoGeneratedInstanceCollectObjects(collectedObjects);
		collectedObjects.Add(Settlement);
	}

	internal static object AutoGeneratedGetMemberValueSettlement(object o)
	{
		return ((GarrisonPartyComponent)o).Settlement;
	}

	public static MobileParty CreateGarrisonParty(string stringId, Settlement settlement, bool isInitialGarrison)
	{
		return MobileParty.CreateParty(stringId, new GarrisonPartyComponent(settlement), delegate(MobileParty mobileParty)
		{
			(mobileParty.PartyComponent as GarrisonPartyComponent).InitializeGarrisonPartyProperties(mobileParty, isInitialGarrison);
		});
	}

	public override void SetWagePaymentLimit(int newLimit)
	{
		Settlement.SetGarrisonWagePaymentLimit(newLimit);
	}

	protected internal GarrisonPartyComponent(Settlement settlement)
	{
		Settlement = settlement;
	}

	protected override void OnInitialize()
	{
		Settlement.Town.GarrisonPartyComponent = this;
	}

	protected override void OnFinalize()
	{
		Settlement.Town.GarrisonPartyComponent = null;
	}

	public override void ClearCachedName()
	{
		_cachedName = null;
	}

	private void InitializeGarrisonPartyProperties(MobileParty mobileParty, bool isInitialGarrison)
	{
		PartyTemplateObject defaultPartyTemplate = Settlement.Culture.DefaultPartyTemplate;
		mobileParty.CurrentSettlement = Settlement;
		int troopNumberLimit = (isInitialGarrison ? ((int)(Settlement.Town.Prosperity * 0.04f + (float)(Settlement.IsTown ? 40 : 0) + 80f)) : 0);
		mobileParty.InitializeMobilePartyAtPosition(defaultPartyTemplate, Settlement.GatePosition, troopNumberLimit);
		mobileParty.Party.SetVisualAsDirty();
		mobileParty.InitializePartyTrade(Campaign.Current.Models.ClanFinanceModel.PartyGoldLowerThreshold);
		mobileParty.Ai.DisableAi();
		mobileParty.Aggressiveness = 0f;
	}
}

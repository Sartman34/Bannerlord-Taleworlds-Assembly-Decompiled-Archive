using System.Collections.Generic;
using System.Xml;
using TaleWorlds.Library;
using TaleWorlds.Localization;
using TaleWorlds.SaveSystem;

namespace TaleWorlds.ObjectSystem;

public class MBObjectBase
{
	[SaveableProperty(1)]
	public string StringId { get; set; }

	[SaveableProperty(2)]
	public MBGUID Id { get; set; }

	[CachedData]
	public bool IsInitialized { get; internal set; }

	[CachedData]
	public bool IsReady { get; set; }

	[CachedData]
	[SaveableProperty(3)]
	internal bool IsRegistered { get; private set; }

	public MBObjectBase()
	{
	}

	public MBObjectBase(MBObjectBase other)
	{
		StringId = other.StringId;
	}

	public MBObjectBase(string stringId)
	{
		StringId = stringId;
	}

	public void AfterInitialized()
	{
		if (IsRegistered)
		{
			IsReady = true;
		}
	}

	public virtual void AfterRegister()
	{
	}

	public virtual void Initialize()
	{
		IsInitialized = true;
	}

	public virtual void Deserialize(MBObjectManager objectManager, XmlNode node)
	{
		Initialize();
		StringId = node.Attributes["id"].Value;
	}

	[LoadInitializationCallback]
	private void BeforeLoad()
	{
		OnBeforeLoad();
	}

	protected virtual void OnBeforeLoad()
	{
		if (IsRegistered)
		{
			MBObjectManager.Instance.TryRegisterObjectWithoutInitialization(this);
			IsInitialized = true;
		}
	}

	public override int GetHashCode()
	{
		return Id.GetHashCode();
	}

	public virtual TextObject GetName()
	{
		return new TextObject(StringId);
	}

	protected virtual void PreAfterLoad()
	{
	}

	public void PreAfterLoadInternal()
	{
		PreAfterLoad();
	}

	protected virtual void AfterLoad()
	{
	}

	public void AfterLoadInternal()
	{
		AfterLoad();
	}

	public void OnRegistered()
	{
		IsRegistered = true;
		AfterRegister();
	}

	public void OnUnregistered()
	{
		IsRegistered = false;
	}

	internal static void AutoGeneratedStaticCollectObjectsMBObjectBase(object o, List<object> collectedObjects)
	{
		((MBObjectBase)o).AutoGeneratedInstanceCollectObjects(collectedObjects);
	}

	protected virtual void AutoGeneratedInstanceCollectObjects(List<object> collectedObjects)
	{
	}

	internal static object AutoGeneratedGetMemberValueStringId(object o)
	{
		return ((MBObjectBase)o).StringId;
	}

	internal static object AutoGeneratedGetMemberValueId(object o)
	{
		return ((MBObjectBase)o).Id;
	}

	internal static object AutoGeneratedGetMemberValueIsRegistered(object o)
	{
		return ((MBObjectBase)o).IsRegistered;
	}
}
